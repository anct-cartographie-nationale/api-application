---
name: Deploy API

on:
  push:
    branches:
      - 'main'

permissions:
  contents: write

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Prepare release
        uses: mgoltzsche/conventional-release@v0

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.6.7

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build

      - name: Prepare and Zip .mjs files
        run: |
          for file in dist/*.mjs; do
            filename=$(basename -- "$file")
            filename_noext="${filename%.*}"
            mv "$file" "dist/index.mjs"
            (cd dist && zip "$filename_noext.zip" "index.mjs")
            rm "dist/index.mjs"
          done

      - name: Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: build
          path: dist

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download build
        uses: actions/download-artifact@v3
        with:
          name: build
          path: build

      - name: Fetch Latest Release
        id: fetch-latest-release
        uses: thebritican/fetch-latest-release@v1

      - name: Set Major Version
        id: set-major-version
        run: echo "MAJOR_VERSION=$(echo ${{ steps.fetch-latest-release.outputs.tag_name }} | cut -d 'v' -f 2 | cut -d '.' -f 1)" >> $GITHUB_ENV

      - name: List files
        run: |
          echo Publishing $MAJOR_VERSION
          ls -la

      - name: Deploy
        uses: jakejarvis/s3-sync-action@master
        with:
          args: --delete
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          SOURCE_DIR: 'build'
          DEST_DIR: $MAJOR_VERSION
